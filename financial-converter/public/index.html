<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financial Statement Converter</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 900px;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .content {
        padding: 40px;
      }

      .tabs {
        display: flex;
        margin-bottom: 30px;
        border-bottom: 2px solid #e5e7eb;
      }

      .tab {
        padding: 15px 30px;
        font-size: 1rem;
        font-weight: 600;
        color: #6b7280;
        background: none;
        border: none;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
      }

      .tab.active {
        color: #4f46e5;
      }

      .tab.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: #4f46e5;
        border-radius: 3px 3px 0 0;
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .tab-content.active {
        display: block;
      }

      .input-group {
        margin-bottom: 25px;
      }

      .input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 10px;
        color: #374151;
        font-size: 1rem;
      }

      textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 14px;
        resize: vertical;
        min-height: 200px;
        transition: border-color 0.3s ease;
      }

      textarea:focus {
        outline: none;
        border-color: #4f46e5;
      }

      .file-upload {
        position: relative;
        border: 2px dashed #d1d5db;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .file-upload:hover {
        border-color: #4f46e5;
        background: #f9fafb;
      }

      .file-upload input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      .file-upload .icon {
        font-size: 3rem;
        color: #9ca3af;
        margin-bottom: 15px;
      }

      .file-upload .text {
        color: #6b7280;
        font-size: 1rem;
      }

      .file-upload .text strong {
        color: #4f46e5;
      }

      .buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
      }

      .btn {
        flex: 1;
        padding: 18px;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .btn-excel {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .btn-csv {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn i {
        font-size: 1.2rem;
      }

      .preview {
        margin-top: 30px;
        padding: 25px;
        background: #f9fafb;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
      }

      .preview h3 {
        color: #374151;
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        font-size: 0.9rem;
      }

      .preview-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }

      .preview-item .label {
        color: #6b7280;
        font-size: 0.8rem;
        margin-bottom: 5px;
      }

      .preview-item .value {
        color: #111827;
        font-weight: 600;
        font-size: 1rem;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      .message {
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        display: none;
      }

      .message.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }

      .message.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .options-section {
        margin-top: 30px;
        padding: 25px;
        background: #f9fafb;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .options-header {
        margin-bottom: 20px;
      }

      .options-header h3 {
        color: #374151;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .option {
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }

      .option-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
      }

      .option-label input {
        margin-right: 10px;
        width: 18px;
        height: 18px;
      }

      .option-description {
        font-size: 0.9rem;
        color: #6b7280;
        margin-left: 28px;
      }

      .history-section {
        margin-top: 30px;
      }

      .history-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
      }

      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }

      .history-item:hover {
        border-color: #4f46e5;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .history-info {
        flex: 1;
      }

      .history-name {
        font-weight: 600;
        color: #111827;
        margin-bottom: 5px;
      }

      .history-meta {
        font-size: 0.85rem;
        color: #6b7280;
        display: flex;
        gap: 15px;
      }

      .history-actions {
        display: flex;
        gap: 10px;
      }

      .history-btn {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        text-decoration: none;
      }

      .history-btn.preview-btn {
        background: #e0e7ff;
        color: #4f46e5;
      }

      .history-btn.download {
        background: #d1fae5;
        color: #059669;
      }

      .history-btn.delete {
        background: #fee2e2;
        color: #dc2626;
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .content {
          padding: 20px;
        }

        .buttons {
          flex-direction: column;
        }

        .tab {
          padding: 12px 20px;
          font-size: 0.9rem;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Financial Statement Converter</h1>
        <p>
          Convert JSON financial data to Excel/CSV with professional formatting
        </p>
      </div>

      <div class="content">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('paste')">
            <i class="fas fa-paste"></i> Paste JSON
          </button>
          <button class="tab" onclick="switchTab('upload')">
            <i class="fas fa-upload"></i> Upload File
          </button>
        </div>

        <div id="paste-tab" class="tab-content active">
          <div class="input-group">
            <label for="jsonInput">Paste your financial statement JSON:</label>
            <textarea
              id="jsonInput"
              placeholder='{
  "company_name": "Hindustan Unilever Limited",
  "financial_data": [
    {
      "particular": "Sale of products",
      "key": "sale_of_products",
      "values": {
        "30.06.2025": "16296",
        "30.06.2024": "15497"
      }
    }
    // ... more data
  ]
}'
            ></textarea>
          </div>
        </div>

        <div id="upload-tab" class="tab-content">
          <div class="input-group">
            <label>Upload JSON file:</label>
            <div class="file-upload">
              <input type="file" id="fileInput" accept=".json" />
              <div class="icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <div class="text">
                <strong>Click to upload</strong> or drag and drop
                <br />
                <span>JSON files only</span>
              </div>
            </div>
            <div
              id="fileName"
              style="margin-top: 10px; color: #6b7280; font-size: 0.9rem"
            ></div>
          </div>
        </div>

        <div class="buttons">
          <button class="btn btn-excel" onclick="generateExcel()">
            <i class="fas fa-file-excel"></i> Generate Excel
          </button>
          <button class="btn btn-csv" onclick="generateCSV()">
            <i class="fas fa-file-csv"></i> Generate CSV
          </button>
        </div>

        <div class="options-section">
          <div class="options-header">
            <h3><i class="fas fa-cog"></i> Generation Options</h3>
          </div>

          <div class="options-grid">
            <div class="option">
              <label class="option-label">
                <input type="checkbox" id="autoDownload" checked />
                <span class="checkmark"></span>
                Auto-download after generation
              </label>
              <div class="option-description">
                File will download automatically after processing
              </div>
            </div>

            <div class="option">
              <label class="option-label">
                <input type="checkbox" id="showPreview" />
                <span class="checkmark"></span>
                Show preview before download
              </label>
              <div class="option-description">
                View file details and preview before downloading
              </div>
            </div>

            <div class="option">
              <label class="option-label">
                <input type="checkbox" id="storeFile" checked />
                <span class="checkmark"></span>
                Store file for later access
              </label>
              <div class="option-description">
                Save file on server for 7 days (view in history)
              </div>
            </div>
          </div>

          <div
            class="history-section"
            id="historySection"
            style="display: none"
          >
            <h3><i class="fas fa-history"></i> Recent Files</h3>
            <div class="history-list" id="historyList"></div>
          </div>
        </div>

        <div class="loading" id="loading">
          <div class="loading-spinner"></div>
          <p>Generating file, please wait...</p>
        </div>

        <div class="message" id="message"></div>

        <div class="preview">
          <h3>Output Preview</h3>
          <div class="preview-grid">
            <div class="preview-item">
              <div class="label">Format</div>
              <div class="value">Professional Financial Statement</div>
            </div>
            <div class="preview-item">
              <div class="label">Periods</div>
              <div class="value">Q1 2025 to FY 2025</div>
            </div>
            <div class="preview-item">
              <div class="label">Columns</div>
              <div class="value">12 Columns (A-L)</div>
            </div>
            <div class="preview-item">
              <div class="label">Rows</div>
              <div class="value">47 Rows with formatting</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Tab switching
      function switchTab(tabName) {
        // Update tabs
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document
          .querySelector(`.tab[onclick="switchTab('${tabName}')"]`)
          .classList.add("active");
        document.getElementById(`${tabName}-tab`).classList.add("active");
      }

      // File input handling
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            document.getElementById(
              "fileName"
            ).textContent = `Selected: ${file.name}`;

            // Read and populate textarea
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const jsonData = JSON.parse(e.target.result);
                document.getElementById("jsonInput").value = JSON.stringify(
                  jsonData,
                  null,
                  2
                );
                switchTab("paste");
              } catch (error) {
                console.error("Error parsing JSON file:", error);
                showMessage("Error reading JSON file", "error");
              }
            };
            reader.readAsText(file);
          }
        });

      // Drag and drop
      const fileUpload = document.querySelector(".file-upload");
      fileUpload.addEventListener("dragover", (e) => {
        e.preventDefault();
        fileUpload.style.borderColor = "#4f46e5";
        fileUpload.style.background = "#f9fafb";
      });

      fileUpload.addEventListener("dragleave", () => {
        fileUpload.style.borderColor = "#d1d5db";
        fileUpload.style.background = "";
      });

      fileUpload.addEventListener("drop", (e) => {
        e.preventDefault();
        fileUpload.style.borderColor = "#d1d5db";
        fileUpload.style.background = "";

        const file = e.dataTransfer.files[0];
        if (file && file.type === "application/json") {
          document.getElementById("fileInput").files = e.dataTransfer.files;
          document.getElementById(
            "fileName"
          ).textContent = `Selected: ${file.name}`;

          // Trigger change event
          const event = new Event("change");
          document.getElementById("fileInput").dispatchEvent(event);
        } else {
          showMessage("Please drop a JSON file", "error");
        }
      });

      // Format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      // Show message
      function showMessage(text, type) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        messageEl.style.display = "block";

        setTimeout(() => {
          messageEl.style.display = "none";
        }, 5000);
      }

      // Toggle loading
      function toggleLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      // Generate Excel
      //   async function generateExcel() {
      //     const jsonInput = document.getElementById("jsonInput").value;
      //     const fileInput = document.getElementById("fileInput").files[0];

      //     if (!jsonInput && !fileInput) {
      //       showMessage("Please provide JSON data or upload a file", "error");
      //       return;
      //     }

      //     toggleLoading(true);

      //     try {
      //       const formData = new FormData();

      //       if (jsonInput) {
      //         // Validate JSON
      //         JSON.parse(jsonInput);
      //         formData.append("data", jsonInput);
      //       } else if (fileInput) {
      //         formData.append("file", fileInput);
      //       }

      //       const response = await fetch("/api/excel", {
      //         method: "POST",
      //         body: formData,
      //       });

      //       if (response.ok) {
      //         const blob = await response.blob();
      //         const url = window.URL.createObjectURL(blob);
      //         const a = document.createElement("a");

      //         // Get filename from response or generate default
      //         const filename =
      //           response.headers
      //             .get("Content-Disposition")
      //             ?.split("filename=")[1]
      //             ?.replace(/"/g, "") || `financial_statement_${Date.now()}.xlsx`;

      //         a.href = url;
      //         a.download = filename;
      //         document.body.appendChild(a);
      //         a.click();
      //         window.URL.revokeObjectURL(url);
      //         a.remove();

      //         showMessage("Excel file generated successfully!", "success");
      //       } else {
      //         const error = await response.json();
      //         showMessage(`Error: ${error.error || error.message}`, "error");
      //       }
      //     } catch (error) {
      //       showMessage(`Error: ${error.message}`, "error");
      //     } finally {
      //       toggleLoading(false);
      //     }
      //   }

      // Generate CSV
      //   async function generateCSV() {
      //     const jsonInput = document.getElementById("jsonInput").value;
      //     const fileInput = document.getElementById("fileInput").files[0];

      //     if (!jsonInput && !fileInput) {
      //       showMessage("Please provide JSON data or upload a file", "error");
      //       return;
      //     }

      //     toggleLoading(true);

      //     try {
      //       const formData = new FormData();

      //       if (jsonInput) {
      //         // Validate JSON
      //         JSON.parse(jsonInput);
      //         formData.append("data", jsonInput);
      //       } else if (fileInput) {
      //         formData.append("file", fileInput);
      //       }

      //       const response = await fetch("/api/csv", {
      //         method: "POST",
      //         body: formData,
      //       });

      //       if (response.ok) {
      //         const blob = await response.blob();
      //         const url = window.URL.createObjectURL(blob);
      //         const a = document.createElement("a");

      //         // Get filename from response or generate default
      //         const filename =
      //           response.headers
      //             .get("Content-Disposition")
      //             ?.split("filename=")[1]
      //             ?.replace(/"/g, "") || `financial_statement_${Date.now()}.csv`;

      //         a.href = url;
      //         a.download = filename;
      //         document.body.appendChild(a);
      //         a.click();
      //         window.URL.revokeObjectURL(url);
      //         a.remove();

      //         showMessage("CSV file generated successfully!", "success");
      //       } else {
      //         const error = await response.json();
      //         showMessage(`Error: ${error.error || error.message}`, "error");
      //       }
      //     } catch (error) {
      //       showMessage(`Error: ${error.message}`, "error");
      //     } finally {
      //       toggleLoading(false);
      //     }
      //   }

      // Load recent files
      async function loadRecentFiles() {
        try {
          const response = await fetch("/api/files?limit=5");
          const data = await response.json();

          if (data.success && data.files.length > 0) {
            const historySection = document.getElementById("historySection");
            const historyList = document.getElementById("historyList");

            historySection.style.display = "block";
            historyList.innerHTML = "";

            data.files.forEach((file) => {
              const historyItem = document.createElement("div");
              historyItem.className = "history-item";

              const icon =
                file.type === "excel"
                  ? '<i class="fas fa-file-excel"></i>'
                  : '<i class="fas fa-file-csv"></i>';

              historyItem.innerHTML = `
                    <div class="history-info">
                        <div class="history-name">${
                          file.companyName || file.originalName
                        }</div>
                        <div class="history-meta">
                            <span>${file.type.toUpperCase()}</span>
                            <span>${formatFileSize(file.size)}</span>
                            <span>${new Date(
                              file.generatedAt
                            ).toLocaleDateString()}</span>
                            <span>Downloads: ${file.downloadCount || 0}</span>
                        </div>
                    </div>
                    <div class="history-actions">
                        <a href="/preview.html?id=${
                          file.id
                        }" class="history-btn preview-btn">
                            <i class="fas fa-eye"></i> Preview
                        </a>
                        <a href="/api/download/${
                          file.id
                        }" class="history-btn download" download>
                            <i class="fas fa-download"></i> Download
                        </a>
                        <button class="history-btn delete" onclick="deleteHistoryFile('${
                          file.id
                        }', this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

              historyList.appendChild(historyItem);
            });
          }
        } catch (error) {
          console.error("Error loading recent files:", error);
        }
      }

      // Delete file from history
      async function deleteHistoryFile(fileId, button) {
        if (!confirm("Are you sure you want to delete this file?")) return;

        try {
          const response = await fetch(`/api/files/${fileId}`, {
            method: "DELETE",
          });
          const data = await response.json();

          if (data.success) {
            button.closest(".history-item").remove();
            showMessage("File deleted successfully", "success");

            // Reload if no files left
            const historyList = document.getElementById("historyList");
            if (historyList.children.length === 0) {
              document.getElementById("historySection").style.display = "none";
            }
          } else {
            showMessage(data.error || "Failed to delete file", "error");
          }
        } catch (error) {
          showMessage("Error deleting file: " + error.message, "error");
        }
      }

      // Update generate functions to include options
      async function generateExcel() {
        const jsonInput = document.getElementById("jsonInput").value;
        const fileInput = document.getElementById("fileInput").files[0];
        const autoDownload = document.getElementById("autoDownload").checked;
        const showPreview = document.getElementById("showPreview").checked;
        const storeFile = document.getElementById("storeFile").checked;

        if (!jsonInput && !fileInput) {
          showMessage("Please provide JSON data or upload a file", "error");
          return;
        }

        toggleLoading(true);

        try {
          const formData = new FormData();

          if (jsonInput) {
            JSON.parse(jsonInput);
            formData.append("data", jsonInput);
          } else if (fileInput) {
            formData.append("file", fileInput);
          }

          const queryParams = new URLSearchParams({
            download: autoDownload,
            preview: showPreview,
            store: storeFile,
          });

          const response = await fetch(`/api/excel?${queryParams}`, {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const contentType = response.headers.get("Content-Type");

            if (
              autoDownload &&
              contentType &&
              contentType.includes("application/vnd.openxmlformats")
            ) {
              // Auto-download - response is a blob
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");

              // Get filename from Content-Disposition header
              const contentDisposition = response.headers.get(
                "Content-Disposition"
              );
              const filename = contentDisposition
                ? contentDisposition.split("filename=")[1]?.replace(/"/g, "")
                : `financial_statement_${Date.now()}.xlsx`;

              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              a.remove();

              showMessage("Excel file downloaded successfully!", "success");
              loadRecentFiles(); // Reload history
              return;
            }

            const result = await response.json();

            if (showPreview && result.previewUrl) {
              // Redirect to preview
              window.location.href = result.previewUrl;
            } else {
              // Show success message with links
              showMessage("Excel file generated successfully!", "success");
              loadRecentFiles(); // Reload history
            }
          } else {
            const error = await response.json();
            showMessage(`Error: ${error.error || error.message}`, "error");
          }
        } catch (error) {
          showMessage(`Error: ${error.message}`, "error");
        } finally {
          toggleLoading(false);
        }
      }

      // Similarly update generateCSV function with the same options
      async function generateCSV() {
        const jsonInput = document.getElementById("jsonInput").value;
        const fileInput = document.getElementById("fileInput").files[0];
        const autoDownload = document.getElementById("autoDownload").checked;
        const showPreview = document.getElementById("showPreview").checked;
        const storeFile = document.getElementById("storeFile").checked;

        if (!jsonInput && !fileInput) {
          showMessage("Please provide JSON data or upload a file", "error");
          return;
        }

        toggleLoading(true);

        try {
          const formData = new FormData();

          if (jsonInput) {
            JSON.parse(jsonInput);
            formData.append("data", jsonInput);
          } else if (fileInput) {
            formData.append("file", fileInput);
          }

          const queryParams = new URLSearchParams({
            download: autoDownload,
            preview: showPreview,
            store: storeFile,
          });

          const response = await fetch(`/api/csv?${queryParams}`, {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const contentType = response.headers.get("Content-Type");

            if (
              autoDownload &&
              contentType &&
              contentType.includes("text/csv")
            ) {
              // Auto-download - response is a blob
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");

              // Get filename from Content-Disposition header
              const contentDisposition = response.headers.get(
                "Content-Disposition"
              );
              const filename = contentDisposition
                ? contentDisposition.split("filename=")[1]?.replace(/"/g, "")
                : `financial_statement_${Date.now()}.csv`;

              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              a.remove();

              showMessage("CSV file downloaded successfully!", "success");
              loadRecentFiles(); // Reload history
              return;
            }

            const result = await response.json();

            if (showPreview && result.previewUrl) {
              window.location.href = result.previewUrl;
            } else {
              showMessage("CSV file generated successfully!", "success");
              loadRecentFiles();
            }
          } else {
            const error = await response.json();
            showMessage(`Error: ${error.error || error.message}`, "error");
          }
        } catch (error) {
          showMessage(`Error: ${error.message}`, "error");
        } finally {
          toggleLoading(false);
        }
      }

      // Load recent files on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadRecentFiles();
      });
    </script>
  </body>
</html>
